# name: Deploy Web App to AWS EC2

# on:
#   push:
#     branches:
#       - main 

# jobs:
#   deploy:
#     name: Build & Deploy
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '23'

#       - name: Prepare SSH key
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa
#           echo "Host *" >> ~/.ssh/config
#           echo "  StrictHostKeyChecking no" >> ~/.ssh/config

#       - name: Upload project to EC2
#         run: |
#           rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa" ./ ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ secrets.APP_DIR }}

#       - name: Set environment variables on EC2
#         run: |
#           ssh -i ~/.ssh/id_rsa ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
#             echo "${{ secrets.ENV_VARS }}" > ${{ secrets.APP_DIR }}/.env
#           EOF

#       - name: Install, build and restart app with PM2
#         run: |
#           ssh -i ~/.ssh/id_rsa ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
#             cd ${{ secrets.APP_DIR }}
#             npm install
#             npm run build
#             pm2 delete next-app || true
#             pm2 start npm --name "next-app" -- start
#             pm2 save
#           EOF
